<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Admin Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { margin: 0; font-family: 'Segoe UI', Arial, sans-serif; background: #f4f6f9; color: #333; }
    .navbar { background: #667eea; padding: 15px; color: white; text-align: center; font-size: 20px; font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    .container { padding: 30px; max-width: 900px; margin: auto; }
    .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.08); margin-bottom: 25px; }
    h3 { margin-top: 0; color: #4a5568; }
    input { padding: 10px; border-radius: 6px; border: 1px solid #cbd5e0; margin: 5px 5px 10px 0; width: calc(45% - 10px); }
    button { padding: 10px 20px; border: none; border-radius: 6px; background: #667eea; color: white; cursor: pointer; transition: background 0.2s; font-weight: 600; }
    button:hover { background: #5a67d8; }
    button:disabled { background: #a0aec0; cursor: not-allowed; }
    .btn-delete { background: #e53e3e; padding: 6px 12px; font-size: 13px; }
    .btn-delete:hover { background: #c53030; }
    .logout { background: #4a5568; margin-top: 20px; }
    table { width: 100%; border-collapse: collapse; margin-top: 15px; background: white; }
    th, td { padding: 12px; border-bottom: 1px solid #edf2f7; text-align: left; }
    th { background: #f8fafc; color: #64748b; font-size: 14px; text-transform: uppercase; }
    .search-box { width: 100%; margin-bottom: 15px; box-sizing: border-box; }
    #loading { text-align: center; display: none; color: #667eea; font-weight: bold; margin: 10px 0; }
  </style>
</head>
<body>

<div class="navbar">Admin Dashboard</div>

<div class="container">
  <div class="card">
    <h3>Create Employee</h3>
    <input type="text" id="name" placeholder="Full Name">
    <input type="text" id="phone" placeholder="Phone Number">
    <button id="createBtn" onclick="createEmployee()">Create Employee</button>
  </div>

  <div class="card">
    <h3>Employee Directory</h3>
    <input type="text" id="search" class="search-box" placeholder="Search by name or phone..." onkeyup="searchUser()">
    
    <div id="loading">Updating list...</div>

    <table id="employeeTable">
      <thead>
        <tr>
          <th>Name</th>
          <th>Phone</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        </tbody>
    </table>

    <button class="logout" onclick="logout()">Logout</button>
  </div>
</div>

<script>
  const API_BASE = "https://employee-policy-system.onrender.com/api/admin";
  const token = localStorage.getItem("adminToken");

  // Auth Guard
  if (!token) {
    window.location.href = "index.html";
  }

  function toggleLoading(show) {
    document.getElementById('loading').style.display = show ? 'block' : 'none';
  }

  async function fetchEmployees() {
    toggleLoading(true);
    try {
      const res = await fetch(`${API_BASE}/employees`, {
        headers: { "Authorization": token }
      });
      
      if (!res.ok) throw new Error("Unauthorized or Server Error");
      
      const data = await res.json();
      const tbody = document.querySelector("#employeeTable tbody");
      tbody.innerHTML = "";

      data.forEach(emp => {
        const row = document.createElement("tr");
        
        // Use textContent for safety against XSS
        const nameCell = document.createElement("td");
        nameCell.textContent = emp.name;
        
        const phoneCell = document.createElement("td");
        phoneCell.textContent = emp.phone;
        
        const statusCell = document.createElement("td");
        statusCell.textContent = emp.policyStatus || "Pending";
        
        const actionCell = document.createElement("td");
        const delBtn = document.createElement("button");
        delBtn.textContent = "Delete";
        delBtn.className = "btn-delete";
        delBtn.onclick = () => deleteEmployee(emp._id);
        actionCell.appendChild(delBtn);

        row.append(nameCell, phoneCell, statusCell, actionCell);
        tbody.appendChild(row);
      });
    } catch (err) {
      alert("Error loading employees: " + err.message);
    } finally {
      toggleLoading(false);
    }
  }

  async function createEmployee() {
    const nameEl = document.getElementById("name");
    const phoneEl = document.getElementById("phone");
    const createBtn = document.getElementById("createBtn");

    if (!nameEl.value || !phoneEl.value) {
      alert("Please fill in all fields");
      return;
    }

    createBtn.disabled = true;
    try {
      const res = await fetch(`${API_BASE}/create-employee`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": token
        },
        body: JSON.stringify({ name: nameEl.value, phone: phoneEl.value })
      });

      const data = await res.json();
      alert(data.message || "Success");
      
      if (res.ok) {
        nameEl.value = "";
        phoneEl.value = "";
        fetchEmployees();
      }
    } catch (err) {
      alert("Failed to create employee");
    } finally {
      createBtn.disabled = false;
    }
  }

  async function deleteEmployee(id) {
    if (!confirm("Are you sure you want to delete this employee?")) return;

    try {
      const res = await fetch(`${API_BASE}/delete-employee/${id}`, {
        method: "DELETE",
        headers: { "Authorization": token }
      });
      const data = await res.json();
      alert(data.message);
      fetchEmployees();
    } catch (err) {
      alert("Error deleting employee");
    }
  }

  function searchUser() {
    const query = document.getElementById("search").value.toLowerCase();
    const rows = document.querySelectorAll("#employeeTable tbody tr");

    rows.forEach(row => {
      const text = row.textContent.toLowerCase();
      row.style.display = text.includes(query) ? "" : "none";
    });
  }

  function logout() {
    localStorage.removeItem("adminToken");
    window.location.href = "index.html";
  }

  // Initial Load
  fetchEmployees();
</script>

</body>
</html>