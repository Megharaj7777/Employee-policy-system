<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Admin Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body { margin: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f0f2f5; color: #333; }
        
        /* Navbar - Adjusted for mobile text size */
        .navbar { 
            background: linear-gradient(to right, #8f94fb, #4e54c8); 
            padding: 15px; 
            color: white; 
            text-align: center; 
            font-size: 20px; 
            font-weight: bold; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); 
        }

        .container { padding: 15px; max-width: 1100px; margin: auto; }

        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); margin-bottom: 20px; }
        
        h3 { margin-top: 0; color: #333; border-bottom: 2px solid #f0f2f5; padding-bottom: 10px; font-size: 18px; }

        /* üîπ Responsive Input Group */
        .input-group { display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap; }
        
        input { 
            flex: 1; 
            min-width: 100%; /* Force full width on mobile */
            padding: 12px; 
            border: 1px solid #ddd; 
            border-radius: 8px; 
            outline: none; 
            font-size: 16px; /* Prevents iOS zoom-on-focus */
        }

        button { 
            width: 100%; /* Full width buttons on mobile */
            padding: 12px 25px; 
            border: none; 
            border-radius: 8px; 
            background: #4e54c8; 
            color: white; 
            cursor: pointer; 
            font-weight: 600; 
            transition: 0.3s; 
        }

        /* üîπ Table Responsiveness */
        .table-wrapper { width: 100%; overflow-x: auto; -webkit-overflow-scrolling: touch; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 20px; min-width: 500px; } /* Ensures table doesn't get squashed */
        
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; font-size: 14px; }
        
        /* Status Badges */
        .status-badge { padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: bold; display: inline-block; white-space: nowrap; }
        .signed { background: #e6fffa; color: #2c7a7b; border: 1px solid #b2f5ea; }
        .disagreed { background: #fff5f5; color: #c53030; border: 1px solid #feb2b2; } 
        .pending { background: #fffaf0; color: #9c4221; border: 1px solid #fbd38d; }
        
        .btn-delete { background: #feb2b2; color: #9b2c2c; width: auto; padding: 6px 12px; font-size: 12px; }
        .logout-btn { background: #4a5568; margin-top: 20px; }

        /* üîπ MEDIA QUERIES for Desktop */
        @media (min-width: 768px) {
            .container { padding: 30px; }
            input { min-width: 200px; }
            button { width: auto; }
            h3 { font-size: 22px; }
            .navbar { font-size: 24px; }
        }
    </style>
</head>
<body>

<div class="navbar">Admin Management Portal</div>

<div class="container">
    <div class="card">
        <h3>Create Account</h3>
        <div class="input-group">
            <input type="text" id="nameInput" placeholder="Full Name">
            <input type="text" id="phoneInput" placeholder="Phone Number">
            <button onclick="createEmployee()">Add Employee</button>
        </div>
    </div>

    <div class="card">
        <h3>Employee Directory</h3>
        
        <div class="input-group" style="margin-bottom: 20px;">
            <input type="text" id="searchInput" placeholder="üîç Search name or phone..." onkeyup="filterEmployees()">
        </div>

        <div id="loader" style="text-align: center; padding: 20px;">Syncing...</div>
        
        <div class="table-wrapper">
            <table id="employeeTable" style="display: none;">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Phone</th>
                        <th>Status</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
        
        <button class="logout-btn" onclick="logout()">Secure Logout</button>
    </div>
</div>

<script>
    const API_BASE = "https://employee-policy-system.onrender.com/api/admin";
    const token = localStorage.getItem("adminToken");

    if (!token) window.location.href = "index.html";

    // üîπ Search Filter Function
    function filterEmployees() {
        const input = document.getElementById("searchInput");
        const filter = input.value.toLowerCase();
        const tbody = document.getElementById("tableBody");
        const tr = tbody.getElementsByTagName("tr");

        for (let i = 0; i < tr.length; i++) {
            const nameCell = tr[i].getElementsByTagName("td")[0];
            const phoneCell = tr[i].getElementsByTagName("td")[1];
            
            if (nameCell || phoneCell) {
                const nameText = nameCell.textContent || nameCell.innerText;
                const phoneText = phoneCell.textContent || phoneCell.innerText;
                
                if (nameText.toLowerCase().indexOf(filter) > -1 || phoneText.indexOf(filter) > -1) {
                    tr[i].style.display = "";
                } else {
                    tr[i].style.display = "none";
                }
            }
        }
    }

    async function fetchEmployees() {
        const loader = document.getElementById("loader");
        const table = document.getElementById("employeeTable");
        const tbody = document.getElementById("tableBody");

        try {
            const res = await fetch(`${API_BASE}/employees`, {
                method: 'GET',
                headers: { 
                    "Authorization": token,
                    "Content-Type": "application/json"
                }
            });

            if (res.status === 401 || res.status === 403) {
                logout();
                return;
            }

            const data = await res.json();
            const employees = data.employees || [];

            tbody.innerHTML = "";
            loader.style.display = "none";
            table.style.display = "table";

            employees.forEach(emp => {
                let statusClass = 'pending';
                let statusLabel = '‚óã Pending';

                if (emp.hasSignedPolicy) {
                    if (emp.policyStatus === 'agreed') {
                        statusClass = 'signed';
                        statusLabel = '‚óè Agreed';
                    } else if (emp.policyStatus === 'disagreed') {
                        statusClass = 'disagreed';
                        statusLabel = '‚óè Disagreed';
                    } else {
                        statusClass = 'signed';
                        statusLabel = '‚óè Signed';
                    }
                }

                const row = `
                    <tr>
                        <td><strong>${emp.name}</strong></td>
                        <td>${emp.phone}</td>
                        <td>
                            <span class="status-badge ${statusClass}">
                                ${statusLabel}
                            </span>
                        </td>
                        <td>
                            <button class="btn-delete" onclick="deleteEmployee('${emp._id}')">Delete</button>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });

            if (employees.length === 0) {
                loader.style.display = "block";
                loader.innerText = "No employees found.";
                table.style.display = "none";
            }

        } catch (err) {
            loader.innerText = "Connection Error: Backend is unreachable.";
        }
    }

    async function createEmployee() {
        const name = document.getElementById("nameInput").value;
        const phone = document.getElementById("phoneInput").value;
        if (!name || !phone) return alert("Please fill all fields");

        try {
            const res = await fetch(`${API_BASE}/create-employee`, {
                method: "POST",
                headers: { 
                    "Content-Type": "application/json",
                    "Authorization": token 
                },
                body: JSON.stringify({ name, phone })
            });

            if (res.ok) {
                document.getElementById("nameInput").value = "";
                document.getElementById("phoneInput").value = "";
                fetchEmployees();
            } else {
                const result = await res.json();
                alert(result.message);
            }
        } catch (err) {
            alert("System error.");
        }
    }

    async function deleteEmployee(id) {
        if (!confirm("Delete permanently?")) return;
        try {
            const res = await fetch(`${API_BASE}/delete-employee/${id}`, {
                method: "DELETE",
                headers: { "Authorization": token }
            });
            fetchEmployees();
        } catch (err) {
            alert("Could not delete.");
        }
    }

    function logout() {
        localStorage.removeItem("adminToken");
        window.location.href = "index.html";
    }

    fetchEmployees();
</script>

</body>
</html>