<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Admin Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body { margin: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f0f2f5; }
        .navbar { background: #4e54c8; background: linear-gradient(to right, #8f94fb, #4e54c8); padding: 15px; color: white; text-align: center; font-size: 22px; font-weight: bold; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .container { padding: 30px; max-width: 1100px; margin: auto; }
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); margin-bottom: 25px; }
        h3 { margin-top: 0; color: #333; border-bottom: 2px solid #f0f2f5; padding-bottom: 10px; }
        .input-group { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 15px; }
        input { flex: 1; min-width: 200px; padding: 12px; border: 1px solid #ddd; border-radius: 8px; outline: none; }
        input:focus { border-color: #4e54c8; }
        button { padding: 12px 25px; border: none; border-radius: 8px; background: #4e54c8; color: white; cursor: pointer; font-weight: 600; transition: 0.3s; }
        button:hover { background: #3a40a8; transform: translateY(-1px); }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 15px; text-align: left; border-bottom: 1px solid #eee; }
        th { color: #666; font-weight: 600; text-transform: uppercase; font-size: 13px; }
        .status-badge { padding: 5px 12px; border-radius: 20px; font-size: 12px; font-weight: bold; }
        .signed { background: #e6fffa; color: #2c7a7b; }
        .pending { background: #fffaf0; color: #9c4221; }
        .btn-delete { background: #feb2b2; color: #9b2c2c; }
        .btn-delete:hover { background: #fc8181; }
        .logout-btn { background: #4a5568; margin-top: 20px; }
        #loader { text-align: center; padding: 20px; color: #4e54c8; font-weight: bold; }
    </style>
</head>
<body>

<div class="navbar">Admin Management Portal</div>

<div class="container">
    <div class="card">
        <h3>Create Employee Account</h3>
        <div class="input-group">
            <input type="text" id="nameInput" placeholder="Enter Full Name">
            <input type="text" id="phoneInput" placeholder="Enter Phone Number">
            <button onclick="createEmployee()">Add Employee</button>
        </div>
    </div>

    <div class="card">
        <h3>Employee Directory</h3>
        <div id="loader">Syncing with database...</div>
        <table id="employeeTable" style="display: none;">
            <thead>
                <tr>
                    <th>Full Name</th>
                    <th>Phone Number</th>
                    <th>Policy Status</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
        <button class="logout-btn" onclick="logout()">Secure Logout</button>
    </div>
</div>

<script>
    const API_BASE = "https://employee-policy-system.onrender.com/api/admin";
    const token = localStorage.getItem("adminToken");

    // Guard Clause
    if (!token) window.location.href = "index.html";

    async function fetchEmployees() {
        const loader = document.getElementById("loader");
        const table = document.getElementById("employeeTable");
        const tbody = document.getElementById("tableBody");

        try {
            const res = await fetch(`${API_BASE}/employees`, {
                method: 'GET',
                headers: { 
                    "Authorization": token, // Matches your strict middleware
                    "Content-Type": "application/json"
                }
            });

            if (res.status === 401 || res.status === 403) {
                alert("Session expired. Please login again.");
                logout();
                return;
            }

            const data = await res.json();
            
            // Critical Fix: Matching your router's { employees: users } structure
            const employees = data.employees || [];

            tbody.innerHTML = "";
            loader.style.display = "none";
            table.style.display = "table";

            employees.forEach(emp => {
                const isSigned = emp.hasSignedPolicy;
                const row = `
                    <tr>
                        <td><strong>${emp.name}</strong></td>
                        <td>${emp.phone}</td>
                        <td>
                            <span class="status-badge ${isSigned ? 'signed' : 'pending'}">
                                ${isSigned ? '● Signed' : '○ Pending'}
                            </span>
                        </td>
                        <td>
                            <button class="btn-delete" onclick="deleteEmployee('${emp._id}')">Delete</button>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });

            if (employees.length === 0) {
                loader.style.display = "block";
                loader.innerText = "No employees found in records.";
                table.style.display = "none";
            }

        } catch (err) {
            loader.innerText = "Connection Error: Backend is unreachable.";
            console.error(err);
        }
    }

    async function createEmployee() {
        const name = document.getElementById("nameInput").value;
        const phone = document.getElementById("phoneInput").value;

        if (!name || !phone) return alert("Please fill all fields");

        try {
            const res = await fetch(`${API_BASE}/create-employee`, {
                method: "POST",
                headers: { 
                    "Content-Type": "application/json",
                    "Authorization": token 
                },
                body: JSON.stringify({ name, phone })
            });

            const result = await res.json();
            if (res.ok) {
                document.getElementById("nameInput").value = "";
                document.getElementById("phoneInput").value = "";
                fetchEmployees();
            } else {
                alert(result.message);
            }
        } catch (err) {
            alert("System error while creating employee.");
        }
    }

    async function deleteEmployee(id) {
        if (!confirm("Delete this employee permanently?")) return;

        try {
            const res = await fetch(`${API_BASE}/delete-employee/${id}`, {
                method: "DELETE",
                headers: { "Authorization": token }
            });
            const result = await res.json();
            alert(result.message);
            fetchEmployees();
        } catch (err) {
            alert("Could not delete record.");
        }
    }

    function logout() {
        localStorage.removeItem("adminToken");
        window.location.href = "index.html";
    }

    // Initial Fetch
    fetchEmployees();
</script>
</body>
</html>