<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Policy Agreement | Employee Portal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: 'Segoe UI', sans-serif; background: #f4f7f6; display: flex; justify-content: center; padding: 20px; margin: 0; }
    .card { background: white; padding: 30px; border-radius: 12px; width: 100%; max-width: 450px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); text-align: center; margin-top: 80px; }
    
    .user-info { margin-bottom: 20px; padding: 10px; border-bottom: 2px solid #eee; }
    .user-name { color: #4e54c8; font-weight: bold; font-size: 1.2rem; }
    
    .status-msg { background: #e6fffa; color: #2c7a7b; padding: 15px; border-radius: 8px; margin-bottom: 20px; display: none; font-weight: bold; border: 1px solid #b2f5ea; }
    .radio-group { margin: 25px 0; display: flex; justify-content: space-around; background: #f8fafc; padding: 15px; border-radius: 8px; }
    
    button { width: 100%; padding: 12px; border: none; border-radius: 8px; background: #4e54c8; color: white; cursor: pointer; margin-top: 10px; font-weight: bold; transition: 0.3s; }
    button:hover { background: #3a40a8; }
    button:disabled { background: #ccc; cursor: not-allowed; }
    
    .btn-logout { background: #cbd5e0; color: #4a5568; margin-top: 20px; }
    .btn-logout:hover { background: #a0aec0; }

    .logo-header { position: absolute; top: 20px; left: 20px; background: white; padding: 10px 15px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); z-index: 1000; }
    .logo-header svg { width: 140px; height: auto; }

    @media (max-width: 600px) {
        .logo-header { top: 10px; left: 10px; padding: 8px 12px; }
        .logo-header svg { width: 110px; }
    }
  </style>
</head>
<body>

<div class="logo-header">
    <svg width="180" height="37" viewBox="0 0 180 37" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M0 15.2309V0.626219C0 0.275961 0.275278 0 0.624669 0H8.036C10.8841 0 13.1922 2.31383 13.1922 5.16896V15.2309Z" fill="#B71530"/>
        </svg>
</div>

<div class="card">
  <div class="user-info">
    Welcome, <span id="displayName" class="user-name">Loading Profile...</span>
  </div>

  <h2>Company Policy Agreement</h2>
  
  <div id="statusMsg" class="status-msg">âœ“ Your response has been recorded.</div>
  
  <p id="instr">Please review the company policy and select your decision:</p>
  
  <div class="radio-group" id="policyOptions">
    <label><input type="radio" name="policy" value="agreed"> I Agree</label>
    <label><input type="radio" name="policy" value="disagreed"> I Disagree</label>
  </div>

  <button id="submitBtn" onclick="submitPolicy()">Submit Response</button>
  <button class="btn-logout" onclick="logout()">Logout</button>
</div>

<script>
  // 1. Get token from storage
  const token = localStorage.getItem("employeeToken");
  const API_URL = "https://employee-policy-system.onrender.com/api/employee";

  // 2. Redirect immediately if no token exists
  if (!token) {
    console.warn("No token found, redirecting to login.");
    window.location.href = "index.html";
  }

  // 3. Load User Data
  async function loadUserData() {
    try {
      const res = await fetch(`${API_URL}/me`, {
        method: "GET",
        headers: { 
          "Authorization": token, // Ensure backend 'protect' middleware reads this correctly
          "Content-Type": "application/json"
        }
      });

      if (res.status === 401) {
        console.error("Token expired or invalid.");
        logout();
        return;
      }

      if (!res.ok) throw new Error("Server responded with error: " + res.status);

      const data = await res.json();
      const user = data.user;

      // Update UI
      document.getElementById("displayName").innerText = user.name || "Employee";

      if (user.hasSignedPolicy) {
        document.getElementById("submitBtn").style.display = "none";
        document.getElementById("statusMsg").style.display = "block";
        document.getElementById("instr").innerHTML = `Your recorded response: <strong>${user.policyStatus.toUpperCase()}</strong>`;
        
        // Disable radio buttons and select the one user picked
        const radios = document.getElementsByName("policy");
        radios.forEach(r => {
          if (r.value === user.policyStatus) r.checked = true;
          r.disabled = true;
        });
      }
    } catch (err) {
      console.error("Fetch Error:", err.message);
      // alert("Session Error. Please login again.");
      // logout(); // Uncomment this once you are sure your /me route is working
    }
  }

  // 4. Submit Decision
  async function submitPolicy() {
    const selected = document.querySelector('input[name="policy"]:checked');
    if (!selected) return alert("Please select either Agree or Disagree.");

    const submitBtn = document.getElementById("submitBtn");
    submitBtn.disabled = true;
    submitBtn.innerText = "Submitting...";

    try {
      const res = await fetch(`${API_URL}/submit-policy`, {
        method: "POST",
        headers: { 
          "Content-Type": "application/json", 
          "Authorization": token 
        },
        body: JSON.stringify({ status: selected.value })
      });

      if (res.ok) {
        alert("Response submitted successfully!");
        location.reload(); 
      } else {
        const errData = await res.json();
        alert("Error: " + (errData.message || "Failed to submit."));
        submitBtn.disabled = false;
        submitBtn.innerText = "Submit Response";
      }
    } catch (err) {
      alert("Network error. Please try again.");
      submitBtn.disabled = false;
      submitBtn.innerText = "Submit Response";
    }
  }

  // 5. Logout
  function logout() {
    localStorage.removeItem("employeeToken");
    window.location.href = "index.html";
  }

  // Initialize
  window.onload = loadUserData;
</script>

</body>
</html>